<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Compare ATOM</title>
    <link rel="icon" type="image/svg+xml" href="/atomto100_.svg">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HHWS3TR8LN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-HHWS3TR8LN');
    </script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #000; color: #fff; min-height: 100vh; -webkit-font-smoothing: antialiased; }
        .container { max-width: 960px; margin: 0 auto; padding: 40px 20px 80px; }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page-header-row { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 4px; }
        .page-brand { font-size: 16px; font-weight: 500; color: #666; text-decoration: none; letter-spacing: 0.5px; transition: color 0.2s; }
        .page-brand:hover { color: #fff; }
        .page-title { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; }
        .page-subtitle { font-size: 14px; color: #555; margin-bottom: 24px; }

        /* â”€â”€ Savings Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .savings-banner {
            display: flex; align-items: center; gap: 14px;
            background: linear-gradient(135deg, #071a07 0%, #050505 100%);
            border: 1px solid #163016; border-radius: 12px;
            padding: 16px 20px; margin-bottom: 16px;
            transition: opacity 0.4s;
        }
        .savings-icon { font-size: 24px; flex-shrink: 0; }
        .savings-content { flex: 1; }
        .savings-main { font-size: 14px; color: #999; }
        .savings-main strong { color: #ccc; }
        .savings-detail { font-size: 17px; font-weight: 600; color: #fff; margin-top: 3px; }
        .green { color: #22c55e; }
        .red { color: #ef4444; }

        /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar {
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 12px;
            padding: 14px 0; border-top: 1px solid #111; border-bottom: 1px solid #111;
        }
        .top-bar-left { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .median-block { display: flex; flex-direction: column; gap: 2px; }
        .median-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .median-value { font-size: 26px; font-weight: 600; letter-spacing: -1px; font-variant-numeric: tabular-nums; }
        .top-bar-right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .buy-size-group { display: flex; gap: 3px; background: #0a0a0a; padding: 3px; border-radius: 8px; }
        .buy-btn {
            padding: 5px 9px; font-size: 11px; font-weight: 500; color: #555;
            background: none; border: none; border-radius: 5px; cursor: pointer;
            transition: all 0.15s; font-family: 'DM Sans', sans-serif;
        }
        .buy-btn:hover { color: #888; }
        .buy-btn.active { color: #fff; background: #1a1a1a; }
        .fees-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .fees-label { font-size: 11px; color: #555; }
        .fees-switch { width: 34px; height: 18px; background: #1a1a1a; border-radius: 9px; position: relative; transition: background 0.2s; border: 1px solid #333; }
        .fees-switch.on { background: #22c55e; border-color: #22c55e; }
        .fees-switch::after { content:''; position: absolute; width: 12px; height: 12px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s; }
        .fees-switch.on::after { transform: translateX(16px); }
        .live-indicator { display: flex; align-items: center; gap: 6px; }
        .live-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        .live-dot.loading { background: #333; animation: none; }
        .live-text { font-size: 11px; color: #555; font-variant-numeric: tabular-nums; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

        /* â”€â”€ TradingView Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chart-wrap { height: 300px; border-bottom: 1px solid #111; overflow: hidden; }
        .chart-wrap iframe { border: none !important; }

        /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-header {
            display: grid;
            grid-template-columns: 160px 100px 140px 1fr 70px 80px 28px;
            gap: 6px; padding: 10px 12px;
            font-size: 10px; color: #444;
            text-transform: uppercase; letter-spacing: 0.8px;
            border-bottom: 1px solid #111;
        }
        .exchange-row {
            display: grid;
            grid-template-columns: 160px 100px 140px 1fr 70px 80px 28px;
            gap: 6px; padding: 13px 12px;
            border-bottom: 1px solid #0d0d0d;
            align-items: center; transition: background 0.15s;
            cursor: pointer; text-decoration: none; color: inherit;
        }
        .exchange-row:hover { background: #080808; }
        .exchange-row.row-pending { opacity: 0.4; }
        .flash-green { animation: flashGreen 0.8s ease; }
        .flash-red   { animation: flashRed 0.8s ease; }
        @keyframes flashGreen { 0% { background: rgba(34,197,94,0.12); } 100% { background: transparent; } }
        @keyframes flashRed   { 0% { background: rgba(239,68,68,0.12); } 100% { background: transparent; } }

        /* Source cell */
        .ex-source-wrap { display: flex; flex-direction: column; gap: 2px; }
        .ex-name { font-size: 14px; font-weight: 500; }
        .ex-name.cheapest { color: #22c55e; }
        .ex-sublabel { font-size: 10px; color: #444; }
        .badge { display: inline-flex; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; letter-spacing: 0.3px; align-self: flex-start; }
        .badge-cex     { background: #111; color: #666; }
        .badge-native  { background: #1a0f35; color: #a78bfa; }
        .badge-wrapped { background: #1f1200; color: #f59e0b; }

        /* Price cell */
        .ex-price { font-size: 14px; font-weight: 500; font-variant-numeric: tabular-nums; }
        .tag { padding: 2px 5px; border-radius: 3px; font-size: 9px; font-weight: 600; letter-spacing: 0.3px; margin-left: 4px; }
        .tag-spot { background: #0a1a0a; color: #22c55e; }
        .tag-dex  { background: #0a1020; color: #60a5fa; }
        .ex-pair { display: block; font-size: 10px; color: #444; margin-top: 2px; }

        /* ATOM received */
        .ex-atoms-wrap { display: flex; flex-direction: column; gap: 1px; }
        .ex-atoms { font-size: 15px; font-weight: 600; font-variant-numeric: tabular-nums; letter-spacing: -0.3px; }
        .ex-atoms.best-value { color: #22c55e; }
        .atoms-unit { font-size: 10px; font-weight: 400; color: #555; margin-left: 2px; }
        .ex-atoms-diff { font-size: 10px; color: #ef4444; }

        /* Spread */
        .ex-spread-wrap { display: flex; align-items: center; gap: 6px; }
        .ex-spread-text { font-size: 12px; font-variant-numeric: tabular-nums; white-space: nowrap; }
        .ex-spread-text.pos  { color: #22c55e; }
        .ex-spread-text.neg  { color: #ef4444; }
        .ex-spread-text.zero { color: #444; }
        .spread-bar-wrap { flex:1; height:2px; background:#111; border-radius:1px; overflow:hidden; min-width:16px; max-width:40px; }
        .spread-bar { height:100%; border-radius:1px; }

        /* Fee + Volume â€” MORE VISIBLE */
        .ex-fee { font-size: 13px; color: #888; font-variant-numeric: tabular-nums; }
        .ex-vol { font-size: 13px; color: #777; font-variant-numeric: tabular-nums; }

        /* Row arrow */
        .ex-arrow { font-size: 14px; color: #333; transition: color 0.15s; text-align: center; }
        .exchange-row:hover .ex-arrow { color: #888; }

        /* Status dot */
        .ex-status { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: middle; }
        .ex-status.live  { background: #22c55e; }
        .ex-status.error { background: #444; }

        /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pagination { display: flex; justify-content: center; gap: 4px; margin-top: 12px; }
        .page-btn {
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            background: transparent; border: 1px solid #222; border-radius: 6px;
            color: #555; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.15s; font-family: 'DM Sans', sans-serif;
        }
        .page-btn:hover { background: #111; color: #888; border-color: #333; }
        .page-btn.active { background: #1a1a1a; color: #fff; border-color: #333; }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .divider { height: 1px; background: #111; margin: 32px 0; }
        .footer { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
        .footer-note { font-size: 12px; color: #555; line-height: 1.7; }
        .back-link { display: inline-flex; align-items: center; gap: 6px; color: #555; text-decoration: none; font-size: 13px; transition: color 0.2s; }
        .back-link:hover { color: #fff; }

        /* â”€â”€ Skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .skel { background:#111; border-radius:3px; display:inline-block; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0%,100% { opacity:0.3; } 50% { opacity:0.65; } }

        /* â”€â”€ Exchange Slide Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .exchange-panel-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 999;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .exchange-panel-overlay.open { opacity: 1; pointer-events: auto; }

        .exchange-panel {
            position: fixed; top: 0; right: -480px;
            width: 480px; height: 100vh;
            background: #0a0a0a; border-left: 1px solid #222;
            z-index: 1000; transition: right 0.3s ease;
            display: flex; flex-direction: column;
        }
        .exchange-panel.open { right: 0; }

        .exchange-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 1px solid #222; flex-shrink: 0;
        }
        .exchange-panel-title {
            font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;
        }
        .exchange-panel-actions { display: flex; align-items: center; gap: 8px; }
        .exchange-panel-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            background: none; border: 1px solid #333; border-radius: 6px;
            color: #666; font-size: 18px; cursor: pointer; transition: all 0.2s;
        }
        .exchange-panel-close:hover { background: #111; color: #fff; }
        .open-external-btn {
            display: flex; align-items: center; gap: 4px;
            padding: 6px 12px; background: none; border: 1px solid #333;
            border-radius: 6px; color: #666; font-size: 11px;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
            font-family: 'DM Sans', sans-serif;
        }
        .open-external-btn:hover { background: #111; color: #fff; border-color: #444; }

        .exchange-panel-iframe {
            flex: 1; width: 100%; border: none;
        }

        .exchange-panel-fallback {
            display: none; flex: 1;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 24px; padding: 40px; text-align: center;
        }
        .exchange-panel-fallback.active { display: flex; }
        .fallback-exchange-name { font-size: 32px; font-weight: 600; letter-spacing: -0.5px; }
        .fallback-pair { font-size: 14px; color: #555; margin-top: -8px; }
        .fallback-price-row { display: flex; align-items: baseline; gap: 8px; }
        .fallback-price { font-size: 42px; font-weight: 600; letter-spacing: -1px; font-variant-numeric: tabular-nums; }
        .fallback-price-label { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .fallback-cta {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 16px 40px; background: #22c55e; border: none;
            border-radius: 12px; color: #000; text-decoration: none;
            font-size: 16px; font-weight: 600; transition: all 0.2s;
            font-family: 'DM Sans', sans-serif; cursor: pointer;
        }
        .fallback-cta:hover { background: #16a34a; transform: translateY(-1px); }
        .fallback-note { font-size: 12px; color: #444; }

        /* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 700px) {
            .table-header, .exchange-row { grid-template-columns: 1fr 90px 110px 28px; }
            .col-spread, .col-fee, .col-vol { display: none; }
            .ex-sublabel { display: none; }
            .ex-atoms { font-size: 13px; }
            .median-value { font-size: 22px; }
            .buy-btn { padding: 4px 6px; font-size: 10px; }
            .chart-wrap { height: 220px; }
            .page-header-row { align-items: center; }
            .page-brand { font-size: 14px; }
            .savings-banner { padding: 12px 14px; }
            .savings-detail { font-size: 15px; }
            .exchange-panel {
                right: 0; bottom: -100%; top: auto;
                width: 100%; height: 85vh;
                border-left: none; border-top: 1px solid #222;
                border-radius: 16px 16px 0 0;
                transition: bottom 0.3s ease;
            }
            .exchange-panel.open { right: 0; bottom: 0; }
        }
        @media (max-width: 480px) {
            .top-bar { flex-direction: column; align-items: flex-start; }
            .container { padding: 24px 14px 60px; }
        }
    </style>
</head>
<body>

<div class="container">

    <div class="page-header-row">
        <div class="page-title">Compare ATOM Prices</div>
        <a href="/" class="page-brand">atomprice.com</a>
    </div>
    <div class="page-subtitle">Where's the cheapest place to buy ATOM right now?</div>

    <!-- Savings Banner -->
    <div class="savings-banner" id="savingsBanner">
        <div class="savings-icon">ğŸ’°</div>
        <div class="savings-content">
            <div class="savings-main" id="savingsMain">Loading best prices...</div>
            <div class="savings-detail" id="savingsDetail">â€”</div>
        </div>
    </div>

    <!-- Top bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="median-block">
                <div class="median-label">Median $/ATOM</div>
                <div class="median-value" id="medianPrice">â€”</div>
            </div>
        </div>
        <div class="top-bar-right">
            <div class="buy-size-group" id="buySizeGroup">
                <button class="buy-btn" data-size="1">$1</button>
                <button class="buy-btn" data-size="100">$100</button>
                <button class="buy-btn active" data-size="1000">$1K</button>
                <button class="buy-btn" data-size="10000">$10K</button>
                <button class="buy-btn" data-size="100000">$100K</button>
                <button class="buy-btn" data-size="1000000">$1M</button>
            </div>
            <div class="fees-toggle" id="feesToggle">
                <span class="fees-label">Inc. Fees</span>
                <div class="fees-switch" id="feesSwitch"></div>
            </div>
            <div class="live-indicator">
                <div class="live-dot loading" id="liveDot"></div>
                <span class="live-text" id="liveText">0/29</span>
            </div>
        </div>
    </div>

    <!-- TradingView Chart -->
    <div class="chart-wrap" id="chartWrap">
        <div id="tradingview_widget"></div>
    </div>

    <!-- Table header -->
    <div class="table-header">
        <div>Source</div>
        <div>Price</div>
        <div id="atomColHeader">ATOM / $1K</div>
        <div class="col-spread">Spread / ATOM</div>
        <div class="col-fee">Fee</div>
        <div class="col-vol">24H Vol</div>
        <div></div>
    </div>

    <!-- Exchange rows (populated dynamically) -->
    <div id="exchangeList"></div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>

    <div class="divider"></div>

    <div class="footer">
        <div class="footer-note">
            Prices refresh every 10s Â· Spread calculated vs median CEX price<br>
            Fees based on standard taker rates Â· DEX prices may vary with liquidity<br>
            Click any row to trade
        </div>
        <a href="/" class="back-link">â† atomprice.com</a>
    </div>

</div>

<!-- Exchange Slide Panel -->
<div class="exchange-panel-overlay" id="exchangeOverlay"></div>
<div class="exchange-panel" id="exchangePanel">
    <div class="exchange-panel-header">
        <span class="exchange-panel-title" id="exchangePanelTitle">Exchange</span>
        <div class="exchange-panel-actions">
            <a class="open-external-btn" id="openExternalBtn" href="#" target="_blank" rel="noopener">Open â†—</a>
            <button class="exchange-panel-close" id="exchangePanelClose">&times;</button>
        </div>
    </div>
    <iframe class="exchange-panel-iframe" id="exchangePanelIframe" src="" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    <div class="exchange-panel-fallback" id="exchangePanelFallback">
        <div class="fallback-exchange-name" id="fallbackExName">Exchange</div>
        <div class="fallback-pair" id="fallbackPair">ATOM / USDT Â· Spot</div>
        <div class="fallback-price-row">
            <span class="fallback-price" id="fallbackPrice">â€”</span>
            <span class="fallback-price-label">$/ATOM</span>
        </div>
        <a class="fallback-cta" id="fallbackDirectLink" href="#" target="_blank" rel="noopener">Buy ATOM on <span id="fallbackCtaName">Exchange</span> â†—</a>
        <div class="fallback-note">Opens in a new tab</div>
    </div>
</div>

<!-- TradingView Widget Script -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let buySize = 1000;
let includesFees = false;
let exchangeData = [];
let medianPrice = null;
let currentPage = 1;
let previousPrices = {};
let resolvedCount = 0;
let totalFetchers = 0;
let renderScheduled = false;
const ROWS_PER_PAGE = 5;

// â”€â”€â”€ Timeout helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function withTimeout(promise, ms) {
    return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
    ]);
}

const PROXIES = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
];

// Direct-first fetch
async function fetchWithProxy(url) {
    try { const r = await withTimeout(fetch(url), 3000); if (r.ok) return await r.json(); } catch(_){}
    for (const proxyFn of PROXIES) {
        try { const r = await withTimeout(fetch(proxyFn(url)), 4000); if (r.ok) return await r.json(); } catch(_){}
    }
    throw new Error('Failed: ' + url);
}

// Proxy-first fetch (for APIs that ALWAYS need CORS proxy)
async function fetchProxyFirst(url) {
    for (const proxyFn of PROXIES) {
        try { const r = await withTimeout(fetch(proxyFn(url)), 4000); if (r.ok) return await r.json(); } catch(_){}
    }
    try { const r = await withTimeout(fetch(url), 3000); if (r.ok) return await r.json(); } catch(_){}
    throw new Error('Failed: ' + url);
}

// Shared CoinGecko price (fetched once, used by Astroport + Osmosis fallback)
let _geckoPromise = null;
function getGeckoPrice() {
    if (!_geckoPromise) {
        _geckoPromise = fetchWithProxy('https://api.coingecko.com/api/v3/simple/price?ids=cosmos&vs_currencies=usd')
            .then(d => d.cosmos?.usd ?? null)
            .catch(() => null);
    }
    return _geckoPromise;
}

// â”€â”€â”€ Exchange Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXCHANGES = [
    // â”€â”€ CEXs â”€â”€
    { id:'binance',    name:'Binance',    type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'okx',        name:'OKX',        type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'bybit',      name:'Bybit',      type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'coinbase',   name:'Coinbase',   type:'cex', feeRate:0.006,  tag:'spot', pair:'ATOM/USD',  vol24hStatic:null },
    { id:'kraken',     name:'Kraken',     type:'cex', feeRate:0.0026, tag:'spot', pair:'ATOM/USD',  vol24hStatic:null },
    { id:'mexc',       name:'MEXC',       type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'kucoin',     name:'KuCoin',     type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'gate',       name:'Gate.io',    type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'htx',        name:'HTX',        type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'bitget',     name:'Bitget',     type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'whitebit',   name:'WhiteBIT',   type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'digifinex',  name:'DigiFinex',  type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'poloniex',   name:'Poloniex',   type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'btse',       name:'BTSE',       type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'coinw',      name:'CoinW',      type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'ascendex',   name:'AscendEX',   type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'bitmart',    name:'BitMart',    type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'xt',         name:'XT.COM',     type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'lbank',      name:'LBank',      type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'phemex',     name:'Phemex',     type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'bingx',      name:'BingX',      type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'pionex',     name:'Pionex',     type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'hotcoin',    name:'Hotcoin',    type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'toobit',     name:'Toobit',     type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'coinex',     name:'CoinEx',     type:'cex', feeRate:0.002,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    { id:'crypto_com', name:'Crypto.com', type:'cex', feeRate:0.001,  tag:'spot', pair:'ATOM/USDT', vol24hStatic:null },
    // â”€â”€ DEXs â”€â”€
    { id:'osmosis',    name:'Osmosis',    type:'native', feeRate:0.002, tag:'dex', pair:'ATOM/USDC', subLabel:'Native Â· Cosmos',  vol24hStatic:null },
    { id:'astroport',  name:'Astroport',  type:'native', feeRate:0.003, tag:'dex', pair:'ATOM/USDC', subLabel:'Native Â· Neutron', vol24hStatic:null },
    { id:'thorchain',  name:'THORChain',  type:'native', feeRate:0.003, tag:'dex', pair:'ATOM/USDC', subLabel:'DEX Â· THORChain',  vol24hStatic:null },
];

const EXCHANGE_URLS = {
    binance:    'https://www.binance.com/en/trade/ATOM_USDT?type=spot',
    okx:        'https://www.okx.com/trade-spot/atom-usdt',
    bybit:      'https://www.bybit.com/en/trade/spot/ATOM/USDT',
    coinbase:   'https://www.coinbase.com/advanced-trade/spot/ATOM-USD',
    kraken:     'https://pro.kraken.com/app/trade/atom-usd',
    mexc:       'https://www.mexc.com/exchange/ATOM_USDT',
    kucoin:     'https://www.kucoin.com/trade/ATOM-USDT',
    gate:       'https://www.gate.com/trade/ATOM_USDT',
    htx:        'https://www.htx.com/trade/atom_usdt',
    bitget:     'https://www.bitget.com/spot/ATOMUSDT',
    whitebit:   'https://whitebit.com/trade/ATOM-USDT',
    digifinex:  'https://www.digifinex.com/en-ww/trade/USDT/ATOM',
    poloniex:   'https://www.poloniex.com/trade/ATOM_USDT',
    btse:       'https://www.btse.com/en/trading/ATOM-USD',
    coinw:      'https://www.coinw.com/spot/atomusdt',
    ascendex:   'https://ascendex.com/en/cashtrade-spottrading/usdt/atom',
    bitmart:    'https://www.bitmart.com/trade/en-US?symbol=ATOM_USDT',
    xt:         'https://www.xt.com/en/trade/atom_usdt',
    lbank:      'https://www.lbank.com/trade/atom_usdt',
    phemex:     'https://phemex.com/spot/trade/ATOMUSDT',
    bingx:      'https://bingx.com/en/spot/ATOMUSDT/',
    pionex:     'https://www.pionex.com/en/trade/ATOM_USDT/Bot',
    hotcoin:    'https://www.hotcoin.com/currencyExchangeTwo/atom_usdt',
    toobit:     'https://www.toobit.com/en-US/spot/ATOM_USDT',
    coinex:     'https://www.coinex.com/en/exchange/ATOM-USDT',
    crypto_com: 'https://crypto.com/exchange/trade/ATOM_USDT',
    osmosis:    'https://app.osmosis.zone/?from=USDC&to=ATOM',
    astroport:  'https://neutron.astroport.fi/swap?from=ibc%2FB559A80D62249C8AA07A380E2A2BEA6E5CA9A6F079C912C3A9E9B494105E4F81&to=ibc%2FC4CFF46FD6DE35CA4CF4CE031E643C8FDC9BA4B99AE598E9B0ED98FE3A2319F9',
    thorchain:  'https://app.thorswap.finance/swap/GAIA.ATOM_ETH.USDC-0XA0B86991C6218B36C1D19D4A2E9EB0CE3606EB48',
};

// â”€â”€â”€ Individual Exchange Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function fetchBinance() {
    const d = await fetchWithProxy('https://api.binance.com/api/v3/ticker/24hr?symbol=ATOMUSDT');
    return { price: parseFloat(d.lastPrice), vol: parseFloat(d.quoteVolume) };
}
async function fetchOKX() {
    const d = await fetchWithProxy('https://www.okx.com/api/v5/market/ticker?instId=ATOM-USDT');
    return { price: parseFloat(d.data[0].last), vol: parseFloat(d.data[0].volCcy24h) };
}
async function fetchBybit() {
    const d = await fetchWithProxy('https://api.bybit.com/v5/market/tickers?category=spot&symbol=ATOMUSDT');
    const t = d.result.list[0];
    return { price: parseFloat(t.lastPrice), vol: parseFloat(t.turnover24h) };
}
async function fetchCoinbase() {
    const [ticker, stats] = await Promise.all([
        fetchWithProxy('https://api.coinbase.com/v2/prices/ATOM-USD/spot'),
        fetchWithProxy('https://api.exchange.coinbase.com/products/ATOM-USD/stats').catch(() => null)
    ]);
    return { price: parseFloat(ticker.data.amount), vol: stats ? parseFloat(stats.volume) * parseFloat(ticker.data.amount) : null };
}
async function fetchKraken() {
    const d = await fetchWithProxy('https://api.kraken.com/0/public/Ticker?pair=ATOMUSD');
    const key = Object.keys(d.result)[0];
    const t = d.result[key];
    return { price: parseFloat(t.c[0]), vol: parseFloat(t.v[1]) * parseFloat(t.c[0]) };
}
async function fetchMEXC() {
    const d = await fetchWithProxy('https://api.mexc.com/api/v3/ticker/24hr?symbol=ATOMUSDT');
    return { price: parseFloat(d.lastPrice), vol: parseFloat(d.quoteVolume) };
}
async function fetchKuCoin() {
    const d = await fetchWithProxy('https://api.kucoin.com/api/v1/market/stats?symbol=ATOM-USDT');
    return { price: parseFloat(d.data.last), vol: parseFloat(d.data.volValue) };
}
async function fetchGate() {
    const d = await fetchWithProxy('https://api.gateio.ws/api/v4/spot/tickers?currency_pair=ATOM_USDT');
    return { price: parseFloat(d[0].last), vol: parseFloat(d[0].quote_volume) };
}
async function fetchHTX() {
    const d = await fetchWithProxy('https://api.huobi.pro/market/detail/merged?symbol=atomusdt');
    return { price: d.tick.close, vol: d.tick.vol };
}
async function fetchBitget() {
    const d = await fetchWithProxy('https://api.bitget.com/api/v2/spot/market/tickers?symbol=ATOMUSDT');
    const t = d.data[0];
    return { price: parseFloat(t.lastPr), vol: parseFloat(t.quoteVolume) };
}
async function fetchWhiteBIT() {
    const d = await fetchWithProxy('https://whitebit.com/api/v4/public/ticker');
    const t = d['ATOM_USDT'];
    return { price: parseFloat(t.last_price), vol: parseFloat(t.quote_volume) };
}
async function fetchDigiFinex() {
    const d = await fetchWithProxy('https://openapi.digifinex.com/v3/ticker?symbol=atom_usdt');
    const t = d.ticker[0];
    return { price: t.last, vol: t.base_vol * t.last };
}
async function fetchPoloniex() {
    const d = await fetchWithProxy('https://api.poloniex.com/markets/ATOM_USDT/ticker24h');
    return { price: parseFloat(d.close), vol: parseFloat(d.quantity) * parseFloat(d.close) };
}
async function fetchBTSE() {
    const d = await fetchWithProxy('https://api.btse.com/spot/api/v3.2/market_summary?symbol=ATOM-USD');
    const t = d[0];
    return { price: t.last, vol: t.volume * t.last };
}
async function fetchCoinW() {
    const d = await fetchProxyFirst('https://api.coinw.com/api/v1/public?command=returnTicker');
    const t = d.data['ATOM_USDT'];
    return { price: parseFloat(t.last), vol: parseFloat(t.quoteVolume) };
}
async function fetchAscendEX() {
    const d = await fetchWithProxy('https://ascendex.com/api/pro/v1/spot/ticker?symbol=ATOM/USDT');
    const t = d.data;
    return { price: parseFloat(t.close), vol: parseFloat(t.volume) * parseFloat(t.close) };
}
async function fetchBitMart() {
    const d = await fetchWithProxy('https://api-cloud.bitmart.com/spot/quotation/v3/ticker?symbol=ATOM_USDT');
    const t = d.data;
    return { price: parseFloat(t.last), vol: parseFloat(t.qv) };
}
async function fetchXT() {
    const d = await fetchProxyFirst('https://sapi.xt.com/v4/public/ticker/24h?symbol=atom_usdt');
    const t = d.result[0];
    return { price: parseFloat(t.c), vol: parseFloat(t.q) };
}
async function fetchLBank() {
    const d = await fetchWithProxy('https://api.lbkex.com/v2/ticker/24hr.do?symbol=atom_usdt');
    const t = d.data[0];
    return { price: parseFloat(t.ticker.latest), vol: parseFloat(t.ticker.turnover) };
}
async function fetchPhemex() {
    const d = await fetchWithProxy('https://api.phemex.com/md/v3/ticker/24hr?symbol=sATOMUSDT');
    const t = d.result;
    return { price: parseFloat(t.lastEp) / 1e8, vol: parseFloat(t.turnoverEv) / 1e8 };
}
async function fetchBingX() {
    const d = await fetchWithProxy('https://open-api.bingx.com/openApi/spot/v1/ticker/24hr?symbol=ATOM-USDT');
    const t = d.data[0];
    return { price: parseFloat(t.lastPrice), vol: parseFloat(t.quoteVolume) };
}
async function fetchPionex() {
    const d = await fetchWithProxy('https://api.pionex.com/api/v1/market/tickers');
    const t = d.data.tickers.find(x => x.symbol === 'ATOM_USDT');
    return { price: parseFloat(t.close), vol: parseFloat(t.amount) };
}
async function fetchHotcoin() {
    const d = await fetchProxyFirst('https://api.hotcoin.com/v1/market/ticker?symbol=atom_usdt');
    const t = d.ticker;
    return { price: parseFloat(t.last), vol: parseFloat(t.vol) * parseFloat(t.last) };
}
async function fetchToobit() {
    const d = await fetchWithProxy('https://api.toobit.com/quote/v1/ticker/24hr?symbol=ATOMUSDT');
    return { price: parseFloat(d.lastPrice), vol: parseFloat(d.volume) * parseFloat(d.lastPrice) };
}
async function fetchCoinEx() {
    const d = await fetchWithProxy('https://api.coinex.com/v2/spot/ticker?market=ATOMUSDT');
    const t = d.data[0];
    return { price: parseFloat(t.last), vol: parseFloat(t.volume) * parseFloat(t.last) };
}
async function fetchCryptoCom() {
    const d = await fetchWithProxy('https://api.crypto.com/exchange/v1/public/get-tickers?instrument_name=ATOM_USDT');
    const t = d.result.data[0];
    return { price: parseFloat(t.a), vol: parseFloat(t.vv) };
}
// â”€â”€ DEX fetchers â”€â”€
async function fetchOsmosis() {
    try {
        const d = await fetchWithProxy('https://api-osmosis.imperator.co/tokens/v2/ATOM');
        if (d?.[0]?.price) return { price: d[0].price, vol: d[0].volume_24h || null };
    } catch(_){}
    // Fallback to CoinGecko
    const price = await getGeckoPrice();
    return price ? { price, vol: null } : null;
}
async function fetchAstroport() {
    const price = await getGeckoPrice();
    return price ? { price, vol: null } : null;
}
async function fetchTHORChain() {
    try {
        const d = await fetchWithProxy('https://midgard.ninerealms.com/v2/pools/GAIA.ATOM');
        const price = parseFloat(d.assetPriceUSD);
        const vol = parseFloat(d.volume24h) / 1e8;
        return { price, vol };
    } catch(_) {}
    const price = await getGeckoPrice();
    return price ? { price, vol: null } : null;
}

const FETCHERS = {
    binance: fetchBinance, okx: fetchOKX, bybit: fetchBybit, coinbase: fetchCoinbase,
    kraken: fetchKraken, mexc: fetchMEXC, kucoin: fetchKuCoin, gate: fetchGate,
    htx: fetchHTX, bitget: fetchBitget, whitebit: fetchWhiteBIT, digifinex: fetchDigiFinex,
    poloniex: fetchPoloniex, btse: fetchBTSE, coinw: fetchCoinW, ascendex: fetchAscendEX,
    bitmart: fetchBitMart, xt: fetchXT, lbank: fetchLBank, phemex: fetchPhemex,
    bingx: fetchBingX, pionex: fetchPionex, hotcoin: fetchHotcoin, toobit: fetchToobit,
    coinex: fetchCoinEx, crypto_com: fetchCryptoCom,
    osmosis: fetchOsmosis, astroport: fetchAstroport, thorchain: fetchTHORChain,
};

// â”€â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderSkeletonTable() {
    const list = document.getElementById('exchangeList');
    list.innerHTML = '';
    for (let i = 0; i < ROWS_PER_PAGE; i++) {
        const row = document.createElement('div');
        row.className = 'exchange-row row-pending';
        row.innerHTML = `
            <div class="ex-source-wrap">
                <span class="ex-name"><span class="ex-status" style="background:#333;"></span><span class="skel" style="width:80px;height:14px;"></span></span>
            </div>
            <div><span class="skel" style="width:65px;height:14px;"></span></div>
            <div><span class="skel" style="width:90px;height:15px;"></span></div>
            <div class="col-spread"><span class="skel" style="width:100px;height:12px;"></span></div>
            <div class="col-fee"><span class="skel" style="width:36px;height:12px;"></span></div>
            <div class="col-vol"><span class="skel" style="width:44px;height:12px;"></span></div>
            <div class="ex-arrow" style="color:#1a1a1a;">â‹¯</div>
        `;
        list.appendChild(row);
    }
}

function scheduleRender() {
    if (renderScheduled) return;
    renderScheduled = true;
    requestAnimationFrame(() => {
        renderScheduled = false;
        recomputeAndRender();
    });
}

function recomputeMedian() {
    const cexPrices = exchangeData
        .filter(e => e.type === 'cex' && e.price !== null)
        .map(e => e.price).sort((a, b) => a - b);
    if (cexPrices.length > 0) {
        const mid = Math.floor(cexPrices.length / 2);
        medianPrice = cexPrices.length % 2 !== 0
            ? cexPrices[mid]
            : (cexPrices[mid - 1] + cexPrices[mid]) / 2;
        document.getElementById('medianPrice').textContent = '$' + medianPrice.toFixed(4);
        document.title = '$' + medianPrice.toFixed(4) + ' ATOM â€” Compare Prices';
    }
}

function recomputeAndRender() {
    recomputeMedian();

    // Sort: cheapest first
    exchangeData.sort((a, b) => {
        if (a.price === null && b.price === null) return 0;
        if (a.price === null) return 1;
        if (b.price === null) return -1;
        return a.price - b.price;
    });

    renderTable();
    updateSavingsBanner();
}

// â”€â”€â”€ Fetch All Prices (Individual Fetchers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchAllPrices() {
    resolvedCount = 0;
    _geckoPromise = null; // Reset shared CoinGecko cache each cycle
    totalFetchers = EXCHANGES.length;
    setLiveState('loading');

    // Initialize exchange data on first run
    if (exchangeData.length === 0) {
        exchangeData = EXCHANGES.map(ex => ({
            ...ex, price: null, vol24hLive: null, error: false, subLabel: ex.subLabel || '',
        }));
    }

    // Store previous prices for flash animation
    exchangeData.forEach(ex => {
        if (ex.price !== null) previousPrices[ex.id] = ex.price;
    });

    // Fire all fetchers in parallel
    EXCHANGES.forEach((ex, idx) => {
        const fetcher = FETCHERS[ex.id];
        if (!fetcher) return;

        fetcher().then(result => {
            if (result && result.price) {
                exchangeData[idx].price = result.price;
                exchangeData[idx].vol24hLive = result.vol || null;
                exchangeData[idx].error = false;
            } else {
                exchangeData[idx].error = true;
            }
        }).catch(() => {
            exchangeData[idx].error = true;
        }).finally(() => {
            resolvedCount++;
            document.getElementById('liveText').textContent = resolvedCount + '/' + totalFetchers;
            scheduleRender();
            if (resolvedCount >= totalFetchers) {
                setLiveState('live');
            }
        });
    });
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatBuySize(s) { return s >= 1e6 ? '$'+s/1e6+'M' : s >= 1e3 ? '$'+s/1e3+'K' : '$'+s; }
function formatAtoms(n) { return n >= 1000 ? n.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1}) : n >= 10 ? n.toFixed(2) : n.toFixed(4); }
function formatFee(bs,fr) { const f=bs*fr; return f<0.01 ? '<$0.01' : f>=1000 ? '$'+(f/1000).toFixed(1)+'K' : '$'+f.toFixed(2); }
function formatVol(v,isStatic) { if (!v) return 'â€”'; const p=isStatic?'~':''; return v>=1e9?p+'$'+(v/1e9).toFixed(1)+'B':v>=1e6?p+'$'+(v/1e6).toFixed(0)+'M':p+'$'+(v/1e3).toFixed(0)+'K'; }

function renderTable() {
    document.getElementById('atomColHeader').textContent = 'ATOM / ' + formatBuySize(buySize);
    const list = document.getElementById('exchangeList');
    list.innerHTML = '';

    const startIdx = (currentPage - 1) * ROWS_PER_PAGE;
    const pageData = exchangeData.slice(startIdx, startIdx + ROWS_PER_PAGE);
    const validAll = exchangeData.filter(e => e.price !== null);
    const bestAtoms = validAll.length > 0 ? buySize / validAll[0].price : null;

    pageData.forEach((ex, localIdx) => {
        const globalIdx = startIdx + localIdx;
        const isBest = globalIdx === 0 && ex.price !== null;
        const badgeClass = ex.type==='cex'?'badge-cex':ex.type==='native'?'badge-native':'badge-wrapped';
        const badgeLabel = ex.type==='cex'?'CEX':ex.type==='native'?'Native':'Wrapped';
        const tagClass = ex.tag==='spot'?'tag-spot':'tag-dex';
        const url = EXCHANGE_URLS[ex.id] || '#';

        // ATOM received
        let atomsHTML = 'â€”', diffHTML = '';
        if (ex.price !== null) {
            const atoms = buySize / ex.price;
            atomsHTML = `<span class="ex-atoms ${isBest?'best-value':''}">${formatAtoms(atoms)}<span class="atoms-unit"> ATOM</span></span>`;
            if (!isBest && bestAtoms) {
                const diff = atoms - bestAtoms;
                diffHTML = `<span class="ex-atoms-diff">${diff.toFixed(1)} ATOM</span>`;
            }
        }

        // Spread
        let spreadHTML = '<span class="ex-spread-text zero">â€”</span>';
        if (ex.price !== null && medianPrice !== null) {
            const sAbs = ex.price - medianPrice;
            const sPct = (sAbs / medianPrice) * 100;
            const sign = sAbs >= 0 ? '+' : '';
            const cls = sAbs < -0.0001 ? 'pos' : sAbs > 0.0001 ? 'neg' : 'zero';
            const barC = sAbs <= 0 ? '#22c55e' : '#ef4444';
            const barW = Math.min(Math.abs(sPct)/5*100, 100)+'%';
            spreadHTML = `<span class="ex-spread-text ${cls}">${sign}$${Math.abs(sAbs).toFixed(4)} (${sign}${sPct.toFixed(3)}%)</span><div class="spread-bar-wrap"><div class="spread-bar" style="width:${barW};background:${barC};"></div></div>`;
        }

        const feeText = ex.price !== null ? formatFee(buySize, ex.feeRate) : 'â€”';
        const vol = ex.vol24hLive || ex.vol24hStatic;
        const isStatic = !ex.vol24hLive && !!ex.vol24hStatic;
        const volText = formatVol(vol, isStatic);

        // Status dot
        const statusClass = ex.price !== null ? 'live' : (ex.error ? 'error' : '');

        // Flash animation
        let flashClass = '';
        if (previousPrices[ex.id] && ex.price !== null && ex.price !== previousPrices[ex.id]) {
            flashClass = ex.price < previousPrices[ex.id] ? 'flash-green' : 'flash-red';
        }
        if (ex.price !== null) previousPrices[ex.id] = ex.price;

        const row = document.createElement('div');
        row.className = `exchange-row ${ex.price === null && !ex.error ? 'row-pending' : ''} ${flashClass}`;
        row.onclick = () => openExchangePanel(ex.name, url, ex.id);
        row.innerHTML = `
            <div class="ex-source-wrap">
                <span class="ex-name ${isBest?'cheapest':''}">${statusClass?'<span class="ex-status '+statusClass+'"></span>':''}${ex.name}${isBest?' âœ“':''}</span>
                ${ex.subLabel?`<span class="ex-sublabel">${ex.subLabel}</span>`:''}
                <span class="badge ${badgeClass}">${badgeLabel}</span>
            </div>
            <div><span class="ex-price">${ex.price!==null?'$'+ex.price.toFixed(4):'â€”'}</span><span class="tag ${tagClass}">${ex.tag.toUpperCase()}</span>${ex.pair?`<span class="ex-pair">${ex.pair}</span>`:''}</div>
            <div class="ex-atoms-wrap">${atomsHTML}${diffHTML}</div>
            <div class="ex-spread-wrap col-spread">${spreadHTML}</div>
            <div class="ex-fee col-fee">${feeText}</div>
            <div class="ex-vol col-vol">${volText}</div>
            <div class="ex-arrow">â†’</div>
        `;
        list.appendChild(row);
    });

    renderPagination();
}

function renderPagination() {
    const el = document.getElementById('pagination');
    const totalItems = exchangeData.length;
    const totalPages = Math.ceil(totalItems / ROWS_PER_PAGE);
    if (totalPages <= 1) { el.innerHTML = ''; return; }
    el.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
        btn.textContent = i;
        btn.addEventListener('click', () => { currentPage = i; renderTable(); });
        el.appendChild(btn);
    }
}

// â”€â”€â”€ Savings Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const bannerSizes = [1000, 10000, 100000, 1000000];
let bannerSizeIdx = 2;

function updateSavingsBanner() {
    const valid = exchangeData.filter(e => e.type === 'cex' && e.price !== null);
    if (valid.length < 2) return;
    const bs = bannerSizes[bannerSizeIdx];
    const cheapest = valid[0];
    const expensive = valid[valid.length - 1];
    const atomsCheap = bs / cheapest.price;
    const atomsExpensive = bs / expensive.price;
    const atomDiff = atomsCheap - atomsExpensive;
    const costDiff = (expensive.price - cheapest.price) * atomsCheap;

    document.getElementById('savingsMain').innerHTML =
        `Buying <strong>${formatBuySize(bs)}</strong> on <span class="green">${cheapest.name}</span> vs <span class="red">${expensive.name}</span>`;
    document.getElementById('savingsDetail').innerHTML =
        `Save <span class="green">~$${costDiff.toFixed(2)}</span> Â· Get <span class="green">+${atomDiff.toFixed(1)} more ATOM</span>`;
}

setInterval(() => {
    bannerSizeIdx = (bannerSizeIdx + 1) % bannerSizes.length;
    updateSavingsBanner();
}, 8000);

// â”€â”€â”€ Live state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLiveState(state) {
    const dot = document.getElementById('liveDot');
    const text = document.getElementById('liveText');
    if (state === 'loading') {
        dot.className = 'live-dot loading';
        text.textContent = '0/' + totalFetchers;
    } else {
        dot.className = 'live-dot';
        const now = new Date();
        text.textContent = now.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', second:'2-digit' });
    }
}

// â”€â”€â”€ Exchange Slide Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentExchangeUrl = '';
let iframeLoadTimer = null;

const DEX_IFRAME = new Set(['osmosis', 'astroport', 'thorchain']);

function openExchangePanel(name, url, exchangeId) {
    currentExchangeUrl = url;
    document.getElementById('exchangePanelTitle').textContent = name;
    document.getElementById('openExternalBtn').href = url;
    document.getElementById('fallbackDirectLink').href = url;

    const iframe = document.getElementById('exchangePanelIframe');
    const fallback = document.getElementById('exchangePanelFallback');

    // Show panel
    document.getElementById('exchangePanel').classList.add('open');
    document.getElementById('exchangeOverlay').classList.add('open');

    // CEXs: show branded CTA (they block iframes)
    if (!DEX_IFRAME.has(exchangeId)) {
        iframe.style.display = 'none';
        iframe.src = '';
        fallback.classList.add('active');

        const exData = exchangeData.find(e => e.id === exchangeId);
        document.getElementById('fallbackExName').textContent = name;
        document.getElementById('fallbackCtaName').textContent = name;
        document.getElementById('fallbackPair').textContent = (exData?.pair || 'ATOM/USDT') + ' Â· Spot';
        document.getElementById('fallbackPrice').textContent = exData?.price ? '$' + exData.price.toFixed(4) : 'â€”';
        return;
    }

    // DEXs: attempt iframe
    iframe.style.display = 'block';
    fallback.classList.remove('active');
    iframe.src = url;

    clearTimeout(iframeLoadTimer);
    iframeLoadTimer = setTimeout(() => showExchangeFallback(), 4000);

    iframe.onload = () => {
        clearTimeout(iframeLoadTimer);
    };
    iframe.onerror = () => {
        clearTimeout(iframeLoadTimer);
        showExchangeFallback();
    };
}

function showExchangeFallback() {
    document.getElementById('exchangePanelIframe').style.display = 'none';
    document.getElementById('exchangePanelFallback').classList.add('active');
}

function closeExchangePanel() {
    clearTimeout(iframeLoadTimer);
    document.getElementById('exchangePanel').classList.remove('open');
    document.getElementById('exchangeOverlay').classList.remove('open');
    setTimeout(() => {
        document.getElementById('exchangePanelIframe').src = '';
        document.getElementById('exchangePanelFallback').classList.remove('active');
        document.getElementById('exchangePanelIframe').style.display = 'block';
    }, 300);
}

document.getElementById('exchangePanelClose').onclick = closeExchangePanel;
document.getElementById('exchangeOverlay').onclick = closeExchangePanel;
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeExchangePanel(); });

// â”€â”€â”€ TradingView Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTradingView() {
    try {
        new TradingView.widget({
            container_id: 'tradingview_widget',
            symbol: 'BINANCE:ATOMUSDT',
            interval: '1',
            timezone: 'Etc/UTC',
            theme: 'dark',
            style: '2',
            locale: 'en',
            hide_top_toolbar: true,
            hide_legend: true,
            allow_symbol_change: false,
            save_image: false,
            backgroundColor: '#000000',
            gridColor: '#0a0a0a',
            width: '100%',
            height: '100%',
            hide_volume: true,
            hide_side_toolbar: true,
            enable_publishing: false,
            withdateranges: false,
        });
    } catch(e) {
        document.getElementById('tradingview_widget').innerHTML =
            '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#333;font-size:13px;">Chart loading...</div>';
    }
}

// â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('buySizeGroup').addEventListener('click', e => {
    const btn = e.target.closest('.buy-btn');
    if (!btn) return;
    document.querySelectorAll('.buy-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    buySize = parseInt(btn.dataset.size);
    currentPage = 1;
    renderTable();
    updateSavingsBanner();
});

document.getElementById('feesToggle').addEventListener('click', () => {
    includesFees = !includesFees;
    document.getElementById('feesSwitch').classList.toggle('on', includesFees);
    renderTable();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
    initTradingView();
    renderSkeletonTable();
    fetchAllPrices();
    setInterval(fetchAllPrices, 10000);
}

init();
</script>
</body>
</html>
