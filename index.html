<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 50px 20px;
        }

        .label {
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 3px;
            color: #444;
            margin-bottom: 32px;
            text-transform: uppercase;
        }

        /* Price Row - Price + Change together */
        .price-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .price {
            font-size: clamp(64px, 16vw, 120px);
            font-weight: 700;
            letter-spacing: -3px;
            line-height: 1;
            transition: color 0.15s ease;
        }

        .price.up { color: #22c55e; }
        .price.down { color: #ef4444; }

        .change {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            align-self: center;
        }

        .change.pos { color: #22c55e; }
        .change.neg { color: #ef4444; }

        /* Currency Selector */
        .currency-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 40px;
        }

        .currency-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #333;
            background: none;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .currency-btn:hover {
            color: #666;
            background: #111;
        }

        .currency-btn.active {
            color: #fff;
            background: #111;
            border-color: #222;
        }

        /* Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .chart-icons {
            display: flex;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-icon {
            width: 44px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
        }

        .chart-icon svg {
            width: 18px;
            height: 18px;
            stroke: #444;
            fill: none;
        }

        .chart-icon:hover svg { stroke: #666; }
        .chart-icon.active { background: #222; }
        .chart-icon.active svg { stroke: #fff; }

        .time-buttons {
            display: flex;
            gap: 4px;
            background: #111;
            border-radius: 8px;
            padding: 4px;
        }

        .time-btn {
            font-size: 11px;
            font-weight: 600;
            color: #444;
            background: none;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .time-btn:hover { color: #666; }
        .time-btn.active { color: #fff; background: #222; }

        /* Chart */
        .chart-area {
            height: 300px;
            margin-bottom: 50px;
        }

        .chart-panel { display: none; height: 100%; }
        .chart-panel.active { display: block; }
        #chartCanvas { width: 100%; height: 100%; }

        /* Stats */
        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat.right {
            text-align: right;
            align-items: flex-end;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 10px;
            color: #444;
            text-transform: lowercase;
        }

        .divider {
            height: 1px;
            background: #1a1a1a;
            margin-bottom: 24px;
        }

        /* Whales */
        .whale-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .whale-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
            position: relative;
        }

        .whale-amount {
            font-size: 15px;
            font-weight: 500;
            color: #fff;
        }

        .whale-link {
            font-size: 15px;
            font-weight: 500;
            color: #444;
            text-decoration: none;
            transition: color 0.2s;
        }

        .whale-link:hover { color: #888; }

        .whale-time {
            font-size: 10px;
            font-weight: 500;
            color: #333;
            position: absolute;
            right: 0;
            top: 0;
        }

        .pagination {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            font-size: 11px;
            font-weight: 500;
            color: #333;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
        }

        .page-btn:hover { color: #555; }
        .page-btn.active { color: #fff; }

        .loading {
            color: #333;
            font-size: 12px;
            padding: 20px 0;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            font-size: 10px;
            color: #222;
        }

        @media (max-width: 500px) {
            .price-row { gap: 10px; }
            .change { font-size: 14px; }
            .stat-value { font-size: 26px; }
            .time-buttons { gap: 2px; padding: 3px; }
            .time-btn { padding: 5px 8px; font-size: 10px; }
            .currency-btn { width: 32px; height: 32px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="label">ATOM</div>
        
        <!-- Price + Change on same line -->
        <div class="price-row">
            <div class="price" id="price">—</div>
            <div class="change pos" id="change">+0.00%</div>
        </div>

        <!-- Currency Selector -->
        <div class="currency-selector">
            <button class="currency-btn active" data-currency="usd" title="US Dollar">$</button>
            <button class="currency-btn" data-currency="eur" title="Euro">€</button>
            <button class="currency-btn" data-currency="gbp" title="British Pound">£</button>
            <button class="currency-btn" data-currency="jpy" title="Japanese Yen">¥</button>
            <button class="currency-btn" data-currency="cny" title="Chinese Yuan">元</button>
            <button class="currency-btn" data-currency="try" title="Turkish Lira">₺</button>
        </div>

        <!-- Chart Controls -->
        <div class="chart-controls">
            <div class="chart-icons">
                <button class="chart-icon active" data-chart="line">
                    <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 17 9 11 13 15 21 7"></polyline>
                        <polyline points="17 7 21 7 21 11"></polyline>
                    </svg>
                </button>
                <button class="chart-icon" data-chart="candle">
                    <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round">
                        <line x1="9" y1="4" x2="9" y2="8"></line>
                        <rect x="7" y="8" width="4" height="8" rx="0.5"></rect>
                        <line x1="9" y1="16" x2="9" y2="20"></line>
                        <line x1="15" y1="6" x2="15" y2="10"></line>
                        <rect x="13" y="10" width="4" height="6" rx="0.5"></rect>
                        <line x1="15" y1="16" x2="15" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="time-buttons">
                <button class="time-btn" data-d="1">1H</button>
                <button class="time-btn active" data-d="1">1D</button>
                <button class="time-btn" data-d="7">1W</button>
                <button class="time-btn" data-d="30">1M</button>
                <button class="time-btn" data-d="365">1Y</button>
                <button class="time-btn" data-d="max">ALL</button>
            </div>
        </div>

        <div class="chart-area">
            <div class="chart-panel active" id="linePanel">
                <canvas id="chartCanvas"></canvas>
            </div>
            <div class="chart-panel" id="candlePanel"></div>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat">
                <div class="stat-value" id="stakingRatio">—%</div>
                <div class="stat-label">staking ratio</div>
            </div>
            <div class="stat right">
                <div class="stat-value" id="inflationRate">—%</div>
                <div class="stat-label">inflation rate</div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Whales -->
        <div class="whale-list" id="whaleList">
            <div class="loading">loading...</div>
        </div>

        <div class="pagination" id="pagination"></div>

        <div class="footer">coingecko · cosmos sdk</div>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const COINGECKO = 'https://api.coingecko.com/api/v3';
        const COSMOS_REST = 'https://rest.cosmos.directory/cosmoshub';
        const MIN_DELEGATION = 50000;
        const PER_PAGE = 5;
        const WHALES_DATA_URL = 'data/whales.json';

        let lastPrice = null;
        let currentCurrency = 'usd';
        let priceData = {};
        let history = [];
        let canvas, ctx;
        let whales = [];
        let page = 1;

        const currencyFormat = {
            usd: { decimals: 2 },
            eur: { decimals: 2 },
            gbp: { decimals: 2 },
            jpy: { decimals: 0 },
            cny: { decimals: 2 },
            try: { decimals: 2 }
        };

        // ===== PRICE =====
        async function fetchPrice() {
            try {
                const currencies = 'usd,eur,gbp,jpy,cny,try';
                const r = await fetch(`${COINGECKO}/simple/price?ids=cosmos&vs_currencies=${currencies}&include_24hr_change=true`);
                const d = await r.json();
                priceData = d.cosmos;
                updatePrice();
            } catch (e) { console.error(e); }
        }

        function updatePrice() {
            const el = document.getElementById('price');
            const chEl = document.getElementById('change');
            
            const price = priceData[currentCurrency];
            const changeKey = `${currentCurrency}_24h_change`;
            const change = priceData[changeKey] || priceData.usd_24h_change || 0;
            
            if (!price) return;

            if (lastPrice !== null && price !== lastPrice) {
                el.classList.remove('up', 'down');
                void el.offsetWidth;
                el.classList.add(price > lastPrice ? 'up' : 'down');
                setTimeout(() => el.classList.remove('up', 'down'), 200);
            }

            animateNum(el, lastPrice || price, price, currencyFormat[currentCurrency].decimals);
            lastPrice = price;

            chEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            chEl.className = 'change ' + (change >= 0 ? 'pos' : 'neg');
        }

        function animateNum(el, from, to, decimals) {
            const start = performance.now();
            function tick(now) {
                const t = Math.min((now - start) / 300, 1);
                const eased = 1 - Math.pow(1 - t, 3);
                const current = from + (to - from) * eased;
                el.textContent = formatNumber(current, decimals);
                if (t < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        function formatNumber(num, decimals) {
            if (decimals === 0) {
                return Math.round(num).toLocaleString('en-US');
            }
            return num.toLocaleString('en-US', { 
                minimumFractionDigits: decimals, 
                maximumFractionDigits: decimals 
            });
        }

        // ===== CHART =====
        async function fetchHistory(days = 1) {
            try {
                const r = await fetch(`${COINGECKO}/coins/cosmos/market_chart?vs_currency=${currentCurrency}&days=${days}`);
                const d = await r.json();
                history = d.prices;
                drawChart();
            } catch (e) { console.error(e); }
        }

        function drawChart() {
            if (!canvas || !history.length) return;

            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);

            const w = rect.width, h = rect.height;
            const pad = { t: 20, r: 50, b: 40, l: 10 };

            const prices = history.map(p => p[1]);
            const min = Math.min(...prices), max = Math.max(...prices);
            const range = max - min || 1;

            ctx.clearRect(0, 0, w, h);

            ctx.strokeStyle = '#111';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 2; i++) {
                const y = pad.t + (i / 2) * (h - pad.t - pad.b);
                ctx.beginPath();
                ctx.moveTo(pad.l, y);
                ctx.lineTo(w - pad.r, y);
                ctx.stroke();
            }

            ctx.beginPath();
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1.5;

            const cw = w - pad.l - pad.r;
            const ch = h - pad.t - pad.b;

            history.forEach((pt, i) => {
                const x = pad.l + (i / (history.length - 1)) * cw;
                const y = pad.t + (1 - (pt[1] - min) / range) * ch;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.stroke();

            ctx.lineTo(pad.l + cw, h - pad.b);
            ctx.lineTo(pad.l, h - pad.b);
            ctx.closePath();
            const grad = ctx.createLinearGradient(0, pad.t, 0, h - pad.b);
            grad.addColorStop(0, 'rgba(80,80,80,0.12)');
            grad.addColorStop(1, 'rgba(80,80,80,0)');
            ctx.fillStyle = grad;
            ctx.fill();

            const decimals = currencyFormat[currentCurrency].decimals;
            ctx.fillStyle = '#333';
            ctx.font = '11px Inter';
            ctx.textAlign = 'right';
            ctx.fillText(formatNumber(max, decimals), w - 8, pad.t + 4);
            ctx.fillText(formatNumber(min, decimals), w - 8, h - pad.b + 4);

            ctx.textAlign = 'center';
            const times = getTimeLabels(history);
            times.forEach((t, i) => {
                const x = pad.l + (i / (times.length - 1)) * cw;
                ctx.fillText(t, x, h - 10);
            });
        }

        function getTimeLabels(data) {
            if (data.length < 2) return [];
            const first = new Date(data[0][0]);
            const last = new Date(data[data.length - 1][0]);
            const diff = last - first;
            const labels = [];
            const count = 5;
            
            for (let i = 0; i < count; i++) {
                const time = new Date(first.getTime() + (diff * i / (count - 1)));
                if (diff < 86400000 * 2) {
                    labels.push(time.toLocaleTimeString('en-US', { hour: 'numeric' }));
                } else if (diff < 86400000 * 60) {
                    labels.push(time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                } else {
                    labels.push(time.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                }
            }
            return labels;
        }

        function initTV() {
            document.getElementById('candlePanel').innerHTML = '';
            new TradingView.widget({
                symbol: 'BINANCE:ATOMUSDT',
                interval: 'D',
                container_id: 'candlePanel',
                width: '100%',
                height: '100%',
                theme: 'dark',
                style: '1',
                hide_top_toolbar: true,
                hide_legend: true,
                hide_side_toolbar: true,
                save_image: false,
                backgroundColor: '#000'
            });
        }

        // ===== STAKING =====
        async function fetchStats() {
            try {
                const [poolR, supplyR, infR] = await Promise.all([
                    fetch(`${COSMOS_REST}/cosmos/staking/v1beta1/pool`),
                    fetch(`${COSMOS_REST}/cosmos/bank/v1beta1/supply/uatom`),
                    fetch(`${COSMOS_REST}/cosmos/mint/v1beta1/inflation`)
                ]);
                const pool = await poolR.json();
                const supply = await supplyR.json();
                const inf = await infR.json();

                const bonded = parseInt(pool.pool.bonded_tokens) / 1e6;
                const total = parseInt(supply.amount.amount) / 1e6;
                const ratio = (bonded / total) * 100;
                const inflation = parseFloat(inf.inflation) * 100;

                document.getElementById('stakingRatio').textContent = ratio.toFixed(1) + '%';
                document.getElementById('inflationRate').textContent = inflation.toFixed(2) + '%';
            } catch (e) {
                document.getElementById('stakingRatio').textContent = '—%';
                document.getElementById('inflationRate').textContent = '—%';
            }
        }

        // ===== RELATIVE TIME =====
        function getRelativeTime(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return diffMins === 0 ? 'Just now' : `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
            return `${Math.floor(diffDays / 365)}y ago`;
        }

        // ===== WHALES =====
        async function fetchWhales() {
            const list = document.getElementById('whaleList');
            list.innerHTML = '<div class="loading">loading...</div>';

            try {
                // Try to load from pre-generated JSON file first
                try {
                    const response = await fetch(WHALES_DATA_URL);
                    if (response.ok) {
                        const data = await response.json();
                        whales = data.whales || [];
                        page = 1;
                        renderWhales();
                        return;
                    }
                } catch (e) {
                    console.log('No cached whale data, fetching live...');
                }

                // Fallback to live fetching (original method, without timestamps)
                const vRes = await fetch(`${COSMOS_REST}/cosmos/staking/v1beta1/validators?status=BOND_STATUS_BONDED&pagination.limit=180`);
                const vData = await vRes.json();

                let allDel = [];
                const topV = vData.validators.sort((a, b) => parseInt(b.tokens) - parseInt(a.tokens)).slice(0, 15);

                for (const v of topV) {
                    try {
                        const dRes = await fetch(`${COSMOS_REST}/cosmos/staking/v1beta1/validators/${v.operator_address}/delegations?pagination.limit=50`);
                        const dData = await dRes.json();
                        if (dData.delegation_responses) {
                            const big = dData.delegation_responses
                                .filter(d => parseInt(d.balance.amount) / 1e6 >= MIN_DELEGATION)
                                .map(d => ({
                                    addr: d.delegation.delegator_address,
                                    amount: parseInt(d.balance.amount) / 1e6
                                }));
                            allDel = allDel.concat(big);
                        }
                    } catch (e) {}
                }

                const map = new Map();
                allDel.forEach(d => {
                    if (!map.has(d.addr) || map.get(d.addr).amount < d.amount) map.set(d.addr, d);
                });
                whales = Array.from(map.values()).sort((a, b) => b.amount - a.amount);
                page = 1;
                renderWhales();
            } catch (e) {
                list.innerHTML = '<div class="loading">unable to load</div>';
            }
        }

        function renderWhales() {
            const list = document.getElementById('whaleList');
            const pag = document.getElementById('pagination');

            if (!whales.length) {
                list.innerHTML = '<div class="loading">no delegations over 50k</div>';
                pag.innerHTML = '';
                return;
            }

            const total = Math.ceil(whales.length / PER_PAGE);
            const start = (page - 1) * PER_PAGE;
            const items = whales.slice(start, start + PER_PAGE);

            list.innerHTML = items.map(w => `
                <div class="whale-row">
                    <span class="whale-amount">${w.amount.toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    <a href="https://www.mintscan.io/cosmos/address/${w.addr}" target="_blank" class="whale-link">Atom</a>
                    ${w.lastDelegationTime ? `<span class="whale-time">${getRelativeTime(w.lastDelegationTime)}</span>` : ''}
                </div>
            `).join('');

            if (total > 1) {
                pag.innerHTML = Array.from({length: Math.min(total, 8)}, (_, i) => 
                    `<button class="page-btn ${i + 1 === page ? 'active' : ''}" data-p="${i + 1}">${i + 1}</button>`
                ).join('');
                pag.querySelectorAll('.page-btn').forEach(b => {
                    b.onclick = () => { page = +b.dataset.p; renderWhales(); };
                });
            } else {
                pag.innerHTML = '';
            }
        }

        // ===== EVENTS =====
        function setup() {
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCurrency = btn.dataset.currency;
                    lastPrice = null;
                    updatePrice();
                    const activeTime = document.querySelector('.time-btn.active');
                    fetchHistory(activeTime ? activeTime.dataset.d : 1);
                };
            });

            document.querySelectorAll('.chart-icon').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.chart-icon').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.chart-panel').forEach(p => p.classList.remove('active'));
                    if (btn.dataset.chart === 'line') {
                        document.getElementById('linePanel').classList.add('active');
                        drawChart();
                    } else {
                        document.getElementById('candlePanel').classList.add('active');
                        initTV();
                    }
                };
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    fetchHistory(btn.dataset.d);
                };
            });

            window.onresize = drawChart;
        }

        // ===== INIT =====
        async function init() {
            canvas = document.getElementById('chartCanvas');
            ctx = canvas.getContext('2d');
            setup();

            await fetchPrice();
            await fetchHistory(1);
            await fetchStats();
            await fetchWhales();

            setInterval(fetchPrice, 5000);
            setInterval(fetchStats, 60000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
